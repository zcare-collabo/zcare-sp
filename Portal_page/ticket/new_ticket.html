<div class="container">
  <div class="container-inner">
      <div class="new-ticket-page">
          <div class="row clearfix">
              <div class="column column--sm-8 ">
                  <h1 class="new-ticket-title">{% translate ticket.submit_ticket_title %}</h1>
                  {% if portal.user.email == null %}
                  <h4 id="ticket_top_h4">개인정보수집이용동의서</h4>
                  <div class="ticket_agreementBox"
                       style="border: 1px solid #ccc; overflow-y: scroll; height: 300px; padding: 30px;">
                      <div class="ticket_terms_box" style="visibility: visible;">
                          <p>
                              SK 주식회사(이하 "회사")가 운영하는 Cloud Z Support 포털(https://support.cloudz.co.kr)(이하 "포털")의 회원이
                              아님에도 Cloud Z Support 서비스(이하 "서비스")의 일부 기능을 사용하기 원하는 경우 아래와 같은 개인정보 수집・이용에 관하여 동의를 하여야
                              합니다.
                          </p>
                          <h2>■ 개인정보의 수집∙이용 동의 (필수 사항)</h2>
                          <table summary="">
                              <colgroup>
                                  <col width="50%">
                                  <col width="30%">
                                  <col width="*">
                              </colgroup>
                              <thead>
                              <tr>
                                  <th>
                                      수집 ∙ 이용 목적
                                  </th>
                                  <th>
                                      수집 ∙ 이용 항목
                                  </th>
                                  <th>
                                      보유 기간
                                  </th>
                              </tr>
                              </thead>
                              <tbody>
                              <tr>
                                  <td>
                                      문의 내용의 확인, 요청사항 처리 등의 Support 서비스 제공, 회원가입 안내
                                  </td>
                                  <td>
                                      이메일, 성명, 서비스 이용 기록
                                  </td>
                                  <td>
                                      문의 시점으로부터 3개월이며, 세부사항은 포털에 게시된 이용약관과 개인정보처리방침을 확인하여 주십시오.
                                  </td>
                              </tr>
                              </tbody>
                          </table>
                          <p>
                              <span>※</span> 위의 개인정보 수집∙이용에 대한 동의를 거부할 권리가 있습니다.<br> 그러나 필수 정보에 대한 동의를 거부할 경우 서비스 제공이
                              제한될 수 있습니다.
                          </p>
                          <p>
                              <span>※</span> 위의 개인정보 수집∙이용 항목 외에 이용자가 문의 사항 등을 기재하면서 본인의 개인정보를 추가 기재한 경우 이용자는 해당 개인정보를
                              회사가 위 보유기간 동안 수집∙이용하는 것에 동의한 것으로 간주됩니다. 문의 사항 등을 기재할 경우 불필요한 개인정보가 기재되지 않도록 유의해 주시기
                              바랍니다.
                          </p>
                          <h2>■ 개인정보의 국외 이전 동의 (필수 사항)</h2>
                          <p>
                              회사는 원활한 서비스 수행 및 개인정보 업무 처리를 위하여 다음과 같이 국외 수탁자에게 이용자 개인정보의 일부 또는 전부를 이전하여 위탁 처리합니다.
                          </p>
                          <table>
                              <tr>
                                  <th scope="row">
                                      이전받는 자 (연락처)
                                  </th>
                                  <td>
                                      Freshworks Inc.<br> (2950 S. Delaware Street, Suite 201, San Mateo, CA 94403
                                      (1-650-513-0514))
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">
                                      이전받는 자가 소재하는 국가
                                  </th>
                                  <td>
                                      미국
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">
                                      이전받는 자의 개인정보 이용목적
                                  </th>
                                  <td>
                                      데이터 저장 및 이메일 전송
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">
                                      이전되는 개인정보의 항목
                                  </th>
                                  <td>
                                      이메일, 성명 서비스 이용 기록<br> 티켓 작성 시 이용자가 추가 기재한 개인정보
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">
                                      이전 시기 및 이전 방법
                                  </th>
                                  <td>
                                      정보통신망을 통해 필요한 경우 수시로 이전
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">
                                      이전받는 자의 개인정보 보유 및 이용기간
                                  </th>
                                  <td>
                                      회사가 개인정보 이용 목적을 달성하거나,<br> 이용자가 개인정보 정정, 삭제를 요청할 때까지
                                  </td>
                              </tr>
                          </table>
                          <h2>■ 포털의 이용약관 준수 동의 (필수 사항)</h2>
                          <p>
                              포털의 회원이 아님에도 서비스의 일부 기능을 사용하고자 하는 경우, 포털에 게시된 이용약관 중 회원 및 이용자의 의무사항을 준수하여야 합니다.<br>
                              <br>
                              <br> 상기 내용을 상세히 확인하고 동의를 했습니다.
                          </p>
                      </div>
                  </div>
                  <!-- 약관 동의 시작 -->
                  <div class="ticket_checkLine">
                      <ul class="profile-edit-form form-horizontal unstyled">
                          <li class="control-group checkbox custom_checkbox field checkbox-wrap">
                              <div class="controls">
                                  <input name="term[all]" type="hidden" value="false">
                                  <input class="checkbox" id="term_all" name="term[all]" type="checkbox"
                                         value="true"><label for="term_all">전체 약관에 동의 합니다.</label>
                              </div>
                          </li>
                          <li class="control-group checkbox custom_checkbox field checkbox-wrap">
                              <div class="controls">
                                  <input name="term[1]" type="hidden" value="false">
                                  <input class="checkbox signup_checkbox required_checkbox" id="term1" name="term[1]"
                                         type="checkbox" value="true"><label for="term1"><em class="em_red">(필수)</em>
                                  개인정보의 수집∙이용(필수 사항)에 동의 합니다.<span class="required_star">*</span></label>
                              </div>
                          </li>
                          <li class="control-group checkbox custom_checkbox field checkbox-wrap">
                              <div class="controls">
                                  <input name="term[2]" type="hidden" value="false">
                                  <input class="checkbox signup_checkbox required_checkbox" id="term2" name="term[2]"
                                         type="checkbox" value="true"><label for="term2"><em class="em_red">(필수)</em>
                                  개인정보의 국외 이전(필수 사항)에 동의 합니다.<span class="required_star">*</span></label>
                              </div>
                          </li>
                          <li class="control-group checkbox custom_checkbox field checkbox-wrap">
                              <div class="controls">
                                  <input name="term[3]" type="hidden" value="false">
                                  <input class="checkbox signup_checkbox required_checkbox" id="term3" name="term[3]"
                                         type="checkbox" value="true"><label for="term3"><em class="em_red">(필수)</em> 포털의
                                  이용약관 준수(필수 사항)에 동의 합니다.<span class="required_star">*</span></label>
                              </div>
                          </li>
                      </ul>
                  </div>
                  {% endif %}
                  <!-- 약관 동의 끝 -->
                  <!-- <a href="javascript:check_csp_api_key_for_user();">CSP Account 조회</a> -->
                  <div id="new_ticket_form_outside_field_csp_accounts_form">
                      <select id="new_ticket_form_outside_field_csp_accounts" onchange="on_csp_account_changed()">
                          <option value="">--</option>
                      </select>
                  </div>
                  <div class="new-ticket-form">
                      {% snippet new_ticket_form %}
                  </div>
                  <!-- 버튼 비활성화 문구 시작 -->
                  {% if portal.user.email == null %}
                  <div id="btn_mention">
                      <p><em class="em_red">* 필수 항목을 모두 동의하셔야 티켓 제출이 가능합니다.</em></p>
                  </div>
                  {% endif %}
                  <!-- 버튼 비활성화 문구 끝 -->
              </div>
              <div class="column column--sm-4" id="new-ticket-search"></div>
          </div>
      </div>
  </div>
</div>

<script type='text/javascript'>
  /*
  비회원일 때 필수 사항 체크 했는지 확인하는 변수 선언
  2020.05.11 추가
*/
  var isChecked = false;

  /* 
  버튼 비활성화 기능
  2020.05.08 추가
*/
  (function ($) {
      $(document).ready(function () {
          $('#helpdesk_ticket_submit').attr('disabled', true);
          const login_email = "{{portal.user.email}}";
        
          // 비회원일 때
          if (login_email == null || login_email.length < 3) {
            isChecked = false;
          } else {
            isChecked = true;
          }          
      })
  })(jQuery);

  /*
  경기도 지원 사업 티켓 시, 필드들 정의
  2020.05.08 추가
*/

  (function ($) {
      $(document).ready(function () {
          // 경기도 지원 사업 티켓 작성
          if (window.location.href.indexOf('?department=salesn') === -1) {
              //Remove additional fields for the default form
              jQuery('#helpdesk_ticket_custom_field_cf_rand910647_866474, #helpdesk_ticket_custom_field_cf_rand669743_866474, #helpdesk_ticket_custom_field_cf_rand557328_866474, #helpdesk_ticket_custom_field_cf_rand558545_866474').parents('.control-group').remove();
          } else {
              //Preselect default values
              $("#helpdesk_ticket_ticket_type option[value='요청']").attr('selected', true);
              $("#helpdesk_ticket_custom_field_cf_csp_866474 option[value='Cloud Z']").attr('selected', true).trigger('change');
              $("#helpdesk_ticket_custom_field_cf_l1_866474_42000275726 option[value='경기도 클라우드 지원사업']").attr('selected', true).trigger('change');
              $("#helpdesk_ticket_custom_field_cf_l2_866474_42000275726 option[value='상담요청']").attr('selected', true);
            
            if(isChecked){
              var submit = document.getElementById("helpdesk_ticket_submit");
              submit.disabled = false;
            }
          }
          //Autofill fields with user contacts
          var $userPhone = "{{ portal.user.phone }}";
          if ($userPhone.length === 0) {
              $userPhone = "{{ portal.user.mobile }}";
          }

          $("#helpdesk_ticket_custom_field_cf_rand910647_866474").val("{{ portal.user.name }}");
          $("#helpdesk_ticket_custom_field_cf_rand669743_866474").val($userPhone);
          $("#helpdesk_ticket_custom_field_cf_rand557328_866474").val("{{ portal.user.company_name }}");
          $("#helpdesk_ticket_custom_field_cf_rand558545_866474").val("{{ portal.user.job_title }}");
      })
  })(jQuery);

  

   //	전체 동의 버튼 기능
  (function ($) {
      $(document).ready(function () {
          $("#term_all").on('click', function () {
              var chkbox = document.getElementsByClassName('signup_checkbox');
              var submit = document.getElementsByName('commit');
              var flag = $("#term_all").is(":checked");

              for (let i = 0; i < chkbox.length; i++) {
                  chkbox[i].checked = flag;
              }

              if (flag) {
                  submit[0].disabled = false;
                  isChecked = true;
                  document.getElementById('btn_mention').style.display = 'none';
              } else {
                  submit[0].disabled = true;
                  isChecked = false;
                  document.getElementById('btn_mention').style.display = 'block';
              }
          })
      })
  })(jQuery);

  // 필수 항목 동의 버튼 기능
  (function ($) {
      $(document).ready(function () {
          $(".required_checkbox").on('click', function () {
              var chkbox = document.getElementsByClassName('required_checkbox');
              var btn = document.getElementsByName('commit');
              var cnt = 0;

              for (let i = 0; i < chkbox.length; i++) {
                  if (chkbox[i].checked) {
                      cnt++;
                  }
              }
              if (cnt == 3) {
                  btn[0].disabled = false;
                  isChecked = true;
                  document.getElementById('btn_mention').style.display = 'none';
              } else {
                  btn[0].disabled = true;
                  isChecked = false;
                  document.getElementById('btn_mention').style.display = 'block';
              }
          })
      })
  })(jQuery);

  const cf_fields = {
      'out_csp_account_form': 'new_ticket_form_outside_field_csp_accounts_form',
      'out_csp_account_selection': 'new_ticket_form_outside_field_csp_accounts',
      'cf_field_csp': 'helpdesk_ticket_custom_field_cf_csp_866474',
      'cf_field_csp_account': 'helpdesk_ticket_custom_field_cf_csp_account_866474',
      'cf_field_csp_case_id': 'helpdesk_ticket_custom_field_cf_csp_case_id_866474',
      'field_subject': 'helpdesk_ticket_subject'
  };
  const user_email = "{{portal.user.email}}";
  let awsAccounts = [];
  let ibmAccounts = [];
  let csp_selection = document.getElementById(cf_fields['cf_field_csp']);
  if (csp_selection != null) {
      csp_selection.addEventListener('change', on_csp_changed);
  }

  function move_account_selection_field_into_ticket_field() {
      let src = document.getElementById(cf_fields['out_csp_account_form']);
      let dest = document.getElementById(cf_fields['cf_field_csp_account']);
      dest.parentNode.insertBefore(src, dest);
  }

  function enable_account_selection_field(enable) {
      let account_form = document.getElementById(cf_fields['out_csp_account_form']);
      let account_input = document.getElementById(cf_fields['cf_field_csp_account']);
      if (enable) {
          account_form.style.display = 'block';
          account_input.style.display = 'none';
      } else {
          account_form.style.display = 'none';
          account_input.style.display = 'block';
      }
  }

  function disable_csp_secure_field() {
      let cspAccountInputText = document.getElementById(cf_fields['cf_field_csp_account']);
      let cspCaseIdInputText = document.getElementById(cf_fields['cf_field_csp_case_id']);
      if (cspAccountInputText != null) {
          cspAccountInputText.readOnly = true;
          cspAccountInputText.title = 'AWS / IBM 전용';
      }

      if (cspCaseIdInputText != null) {
          cspCaseIdInputText.readOnly = true;
      }
  }

  function hide_custom_field_csp_account_field() {
      document.getElementById(cf_fields['out_csp_account_form']).style.display = 'none';
  }

  function on_csp_changed() {
      let cf_csp_accounts = document.getElementById(cf_fields['out_csp_account_selection']);
      let csp_selector = document.getElementById(cf_fields['cf_field_csp']);
      let selectedValue = csp_selector.options[csp_selector.selectedIndex].value;
      let selectedText = csp_selector.options[csp_selector.selectedIndex].text;
    
      /*
    버튼 비활성화를 위한 변수 선언
    2020.05.08 추가
  */
      let submit = document.getElementById('helpdesk_ticket_submit');
    
      if (selectedText == 'IBM') {
          document.getElementById(cf_fields['field_subject']).placeholder = '제목과 내용을 영문으로 작성해주세요.';
          enable_account_selection_field(true);
        
          /*
      버튼 비활성화
      2020.05.08 추가
    */
          submit.disabled = true;
      } else if (selectedText == 'AWS') {
          enable_account_selection_field(true);
          /*
      버튼 비활성화
      2020.05.08 추가
    */
          submit.disabled = true;
      } else if (selectedText == 'Cloud Z'){
          enable_account_selection_field(false);
          document.getElementById(cf_fields['field_subject']).placeholder = '';
          /*
      버튼 비활성화
      2020.05.08 추가
    */
          if(isChecked) {
            submit.disabled = false;
          }
      } else {
        submit.disabled = true;
      }

      check_csp_api_key_for_user(selectedText);
  }

  function on_csp_account_changed() {
      let csp_account_selector = document.getElementById(cf_fields['out_csp_account_selection']);
      let cspAccountInputText = document.getElementById(cf_fields['cf_field_csp_account']);
    
    
      /*
    버튼 비활성화를 위한 변수 선언
    2020.05.08 추가
  */
      let submit = document.getElementById('helpdesk_ticket_submit');
    
      //let csp_account_selector = document.getElementById('helpdesk_ticket_custom_field_cf_account_name_866474');
      let selectedValue = '';
      //let selectedText = '';
      if (csp_account_selector.length > 0) {
          selectedValue = csp_account_selector.options[csp_account_selector.selectedIndex].value;
          //selectedText = csp_account_selector.options[csp_account_selector.selectedIndex].text;
      }
    
      /*
    버튼 비활성화 기능
    2020.05.08 추가
  */
      if (selectedValue == '') {
        submit.disabled = true;
      } else if(isChecked){
          submit.disabled = false;
      }
    
      //cspAccountInputText.style.display = 'none';
      cspAccountInputText.value = selectedValue;
      cspAccountInputText.readOnly = true;
  }

  /*
  IE 호환을 위해 arrow function을 일반 function으로 변경
  2020.05.12 추가
*/
  function check_csp_api_key_for_user(selectedCsp) {
      awsAccounts = [];
      ibmAccounts = [];
      get_user_api_key_list_from_cloudz_portal(user_email)
          .then(function(result) {
              let infoList = result['userCloudApiInfoList'];
              let apiKeyResult = {
                  'email': user_email
              };
              let awsKeyList = [];
              let ibmKeyList = [];
              for (let i = 0; i < infoList.length; i++) {
                  let info = infoList[i];
                  let customerName = info['customerName'];
                  if (info.hasOwnProperty('awsApiInfo')) {
                      let account = {
                          'displayName': customerName,
                          'id': info['awsApiInfo']['accountId']
                      };
                      awsKeyList.push(account);
                  }
                  if (info.hasOwnProperty('slApiInfo')) {
                      let account = {
                          'displayName': customerName,
                          'id': info['slApiInfo']['apiId']
                      };
                      ibmKeyList.push(account);
                  }
              }
              apiKeyResult['aws'] = awsKeyList;
              apiKeyResult['ibm'] = ibmKeyList;
              if (apiKeyResult.hasOwnProperty('aws')) {
                  let awsIds = apiKeyResult['aws'];
                  for (let i = 0; i < awsIds.length; i++) {
                      awsAccounts.push(awsIds[i]);
                      //option_list += make_account_option(user_email, "AWS", awsIds[i]);
                  }
              }
              if (apiKeyResult.hasOwnProperty('ibm')) {
                  let ibmIds = apiKeyResult['ibm'];
                  for (let i = 0; i < ibmIds.length; i++) {
                      ibmAccounts.push(ibmIds[i]);
                      //option_list += make_account_option(user_email, "IBM", ibmIds[i]);
                  }
              }
              let option_list = make_empty_option();
              let cf_csp_accounts = document.getElementById(cf_fields['out_csp_account_selection']);
              if (selectedCsp == 'AWS') {
                  for (let i = 0; i < awsAccounts.length; i++) {
                      option_list += make_account_option(user_email, "AWS", awsAccounts[i]);
                  }
                  cf_csp_accounts.innerHTML = option_list;
                  on_csp_account_changed();
              } else if (selectedCsp == 'IBM') {
                  for (let i = 0; i < ibmAccounts.length; i++) {
                      option_list += make_account_option(user_email, "IBM", ibmAccounts[i]);
                  }
                  cf_csp_accounts.innerHTML = option_list;
                  on_csp_account_changed();
              } else {
                  let cspAccountInputText = document.getElementById(cf_fields['cf_field_csp_account']);
                  //cspAccountInputText.style.display = 'none';
                  cspAccountInputText.value = '';
                  cf_csp_accounts.innerHTML = option_list;
              }
          })
          .catch(function (err1) {
              //console.error(err1)
          });
  }

  function make_account_option(email, csp, account) {
      return "<option value=\"" + email + "/" + account['id'] + "\">" + csp + " / " + account['displayName'] + " / " + account['id'] + "</option>";
  }

  function make_empty_option() {
      return "<option value=\"\">--</option>";
  }

  function get_user_api_key_list_from_cloudz_portal(user_email) {
      const target_api = "https://ticket-ibm.cloudzcp.io/cloudz/getAccounts?email=" + user_email;
      const auth_key = 'JPkvz365YpRnQwOWQK1r';
      const req = new Request(target_api, {
          method: "GET",
          headers: new Headers({
              "authorization": auth_key,
              "content-type": "application/json",
          })
      });
      return fetch(req).then(function (response) {
          return response.json();
      });
  }

  function is_beta_tester(email) {
      const beta_testers = [
          "yschang88@sk.com",
          "jhk81@sk.com",
          "yunmin.kwon@sk.com",
          "06516@sk.com",
          "vanessa.lee@sk.com",
          "jiyoung.jung@sk.com",
          "sch@sk.com",
          "dmltkr@sk.com",
          "seonbin@sk.com",
          "cybaster@sk.com",
          "davidkss0917@sk.com",
          "fadeawap@sk.com",
          "lefthand@sk.com",
          "lyw292613@sk.com",
          "everless@sk.com",
          "euijun.jung@sk.com",
          "sk_leejin@sk.com",
          "ljh@sk.com",
          "skcc_0125@sk.com",
          "minsu1017@sk.com",
          "wdchoi@sk.com",
          "seoingood@sk.com",
          "dt_admin@sk.com",
          "pjs1214@sk.com",
          "1900569@partner.skcc.com",
          "mslee@uws.co.kr",
          "1900513@partner.skcc.com",
          "wbhong@uws.co.kr",
          "2000083@partner.skcc.com",
          "mjkang@uws.co.kr",
          "1900593@partner.skcc.com",
          "sjchoi@uws.co.kr",
          "2000170@partner.skcc.com",
          "jslee@uws.co.kr",
          "2000059@partner.skcc.com",
          "swpark@uws.co.kr"
      ];
      if (email != null) {
          return beta_testers.includes(email);
      }
      return false;
  }

  (function ($) {
      $(document).ready(function () {
          const login_email = "{{portal.user.email}}";
          move_account_selection_field_into_ticket_field();
          disable_csp_secure_field();
          enable_account_selection_field(false);
          if (login_email == null || login_email.length < 3 || !is_beta_tester(login_email)) {
              hide_custom_field_csp_account_field();
          }
      })
  })(jQuery);
</script>